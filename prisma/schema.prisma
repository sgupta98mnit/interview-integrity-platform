// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum SessionStatus {
  ACTIVE
  SUBMITTED
  ENDED
}

enum IntegrityEventType {
  FOCUS_LOSS
  FOCUS_GAIN
  PAGE_HIDDEN
  PAGE_VISIBLE
  FULLSCREEN_ENTER
  FULLSCREEN_EXIT
  CLIPBOARD_COPY
  CLIPBOARD_CUT
  CLIPBOARD_PASTE
  PASTE_ANALYZED
  TYPING_BUCKET
  IDLE
  EDITOR_CHANGE
  SESSION_SUBMIT
}

enum SnapshotKind {
  RUN
  SUBMIT
}

enum CodeLanguage {
  javascript
  typescript
}

model Session {
  id             String        @id @default(cuid())
  candidateName  String?
  candidateEmail String?
  status         SessionStatus @default(ACTIVE)
  tokenNonce     String
  createdAt      DateTime      @default(now())
  submittedAt    DateTime?
  lastActivityAt DateTime      @default(now())
  events         Event[]
  snapshots      CodeSnapshot[]
  reviewSummary  ReviewSummary?
}

model Event {
  id            String             @id @default(cuid())
  sessionId     String
  clientEventId String
  tsISO         DateTime
  type          IntegrityEventType
  metadata      Json
  createdAt     DateTime           @default(now())
  session       Session            @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, clientEventId])
  @@index([sessionId, tsISO])
}

model CodeSnapshot {
  id        String       @id @default(cuid())
  sessionId String
  kind      SnapshotKind
  code      String
  language  CodeLanguage
  tsISO     DateTime
  createdAt DateTime     @default(now())
  session   Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

model ReviewSummary {
  id         String   @id @default(cuid())
  sessionId  String   @unique
  metrics    Json
  flags      Json
  computedAt DateTime @default(now())
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}
